name: Frontend Master Checks

on:
  push:
    branches:
      - master
    paths:
      - 'products/**/frontend/**'
      - 'packages/frontend/**'
  workflow_dispatch:
    inputs:
      product:
        description: 'Product to deploy'
        required: false
        type: choice
        options:
          - all
          - customers
          - funnels
          - socials
          - websites
        default: 'all'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - id: set-matrix
      name: Detect changed products
      shell: bash
      run: |
        # If manually triggered with specific product
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.product }}" != "all" ]]; then
          echo "Deploying specific product: ${{ github.event.inputs.product }}"
          echo "matrix=[\"${{ github.event.inputs.product }}\"]" >> $GITHUB_OUTPUT
          exit 0
        fi

        # If manually triggered with "all", deploy all products
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.product }}" == "all" ]]; then
          echo "Deploying all products (manual trigger)"
          echo "matrix=[\"customers\", \"funnels\", \"socials\", \"websites\"]" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Detect file changes
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"

        # Check if packages directory has changes
        if echo "$CHANGED_FILES" | grep "packages/frontend"; then
          echo "Changes detected in shared packages, deploying all products"
          echo "matrix=[\"customers\", \"funnels\", \"socials\", \"websites\"]" >> $GITHUB_OUTPUT
          exit 0
        fi

        PRODUCTS=()

        # Check each product for changes without using grep -q
        if echo "$CHANGED_FILES" | grep "products/maistro-customers/frontend"; then
          echo "Changes detected in maistro-customers"
          PRODUCTS+=("customers")
        fi

        if echo "$CHANGED_FILES" | grep "products/maistro-funnels/frontend"; then
          echo "Changes detected in maistro-funnels"
          PRODUCTS+=("funnels")
        fi

        if echo "$CHANGED_FILES" | grep "products/maistro-socials/frontend"; then
          echo "Changes detected in maistro-socials"
          PRODUCTS+=("socials")
        fi

        if echo "$CHANGED_FILES" | grep "products/maistro-websites/frontend"; then
          echo "Changes detected in maistro-websites"
          PRODUCTS+=("websites")
        fi

        # Create JSON array for matrix
        if [ ${#PRODUCTS[@]} -eq 0 ]; then
          echo "No product-specific changes detected"
          echo "matrix=[]" >> $GITHUB_OUTPUT
        else
          JSON_ARRAY=$(printf '"%s",' "${PRODUCTS[@]}" | sed 's/,$//')
          echo "matrix=[${JSON_ARRAY}]" >> $GITHUB_OUTPUT
          echo "Products to deploy: [${JSON_ARRAY}]"
        fi

  build-and-deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}

    runs-on: ubuntu-latest
    strategy:
      matrix:
        product: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      run: pnpm install

    - name: Format
      run: pnpm format:${{ matrix.product }}

    - name: Lint
      run: pnpm lint:${{ matrix.product }}
    
    - name: Test
      run: pnpm test:${{ matrix.product }}
    
    - name: Build
      run: pnpm build:${{ matrix.product }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets[format('MAISTRO_{0}_CI_AWS_ACCESS_KEY_ID', upper(matrix.product))] }}
        aws-secret-access-key: ${{ secrets[format('MAISTRO_{0}_CI_AWS_SECRET_ACCESS_KEY', upper(matrix.product))] }}
        aws-region: us-east-1

    - name: Deploy to S3
        run: |
          aws s3 sync ./products/maistro-${{ matrix.product }}/frontend/dist/ s3://maistro-${{ matrix.product }}-hosting-prod/ --delete

  # - name: Invalidate CloudFront
  #   run: |
  #     aws cloudfront create-invalidation \
  #       --distribution-id ${{ secrets[format('MAISTRO_{0}_CLOUDFRONT_DISTRIBUTION_ID', upper(matrix.product))] }} \
  #       --paths "/*"